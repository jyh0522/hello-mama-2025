<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Hello Mama · Drive GLB Loader</title>
<style>
  html,body{height:100%;margin:0;background:#0b0b0b;overflow:hidden}
  #ui{position:fixed;left:12px;top:12px;color:#9aa;font:12px/1.4 system-ui}
  #ui button{margin-right:8px;padding:8px 12px;border:1px solid #666;background:#171717;color:#eee;border-radius:8px;cursor:pointer}
  #log{position:fixed;left:12px;bottom:12px;color:#9aa;font:11px/1.4 monospace;white-space:pre-wrap;max-width:70vw}
</style>
</head>
<body>
<div id="ui">
  <button id="start">▶ Audio</button>
  <span id="fps">FPS: --</span>
</div>
<div id="log"></div>
<canvas id="c"></canvas>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.159.0/build/three.module.js';
import { GLTFLoader } from 'https://unpkg.com/three@0.159.0/examples/jsm/loaders/GLTFLoader.js';
import { DRACOLoader } from 'https://unpkg.com/three@0.159.0/examples/jsm/loaders/DRACOLoader.js';
import { KTX2Loader }  from 'https://unpkg.com/three@0.159.0/examples/jsm/loaders/KTX2Loader.js';
import { OrbitControls } from 'https://unpkg.com/three@0.159.0/examples/jsm/controls/OrbitControls.js';

const log = (m)=>{ document.getElementById('log').textContent = String(m); };

// ----- Renderer -----
const canvas = document.getElementById('c');
const renderer = new THREE.WebGLRenderer({ canvas, antialias:false, powerPreference:'high-performance' });
let DPR = Math.min(devicePixelRatio || 1, 1.5);
renderer.setPixelRatio(DPR);
renderer.setSize(innerWidth, innerHeight, false);
renderer.outputColorSpace = THREE.SRGBColorSpace;
addEventListener('resize', ()=>{
  renderer.setSize(innerWidth, innerHeight, false);
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
});

// ----- Scene / Camera / Controls -----
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0b0b0b);
const camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.1, 5000);
camera.position.set(0, 2, 6);
const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;

// Lights
scene.add(new THREE.AmbientLight(0xffffff, 0.65));
const dir = new THREE.DirectionalLight(0xffffff, 1.0);
dir.position.set(3,5,2); scene.add(dir);

// ----- Loaders (Draco + KTX2 optional) -----
const gltfLoader = new GLTFLoader();
const draco = new DRACOLoader().setDecoderPath('https://unpkg.com/three@0.159.0/examples/jsm/libs/draco/');
gltfLoader.setDRACOLoader(draco);
const ktx2 = new KTX2Loader().setTranscoderPath('https://unpkg.com/three@0.159.0/examples/jsm/libs/basis/');
ktx2.detectSupport(renderer);
gltfLoader.setKTX2Loader(ktx2);

// ----- Google Drive direct download URL -----
const FILE_ID = '1I1-wJSHexynCCb4ZU7sQny29hpcYpcaq';
const glbURL = `https://drive.google.com/uc?export=download&id=${FILE_ID}`;

// CORS 힌트
gltfLoader.setCrossOrigin('anonymous');

// Load GLB
let model;
gltfLoader.load(glbURL, (gltf)=>{
  model = gltf.scene;
  // 재질 최적화
  model.traverse(o=>{
    if (o.isMesh && o.material){
      o.material.transparent = false;
      o.material.side = THREE.FrontSide;
      o.material.depthWrite = true;
    }
  });
  scene.add(model);

  // 카메라 자동 프레이밍
  const box = new THREE.Box3().setFromObject(model);
  const size = box.getSize(new THREE.Vector3()).length();
  const center = box.getCenter(new THREE.Vector3());
  controls.target.copy(center);
  const dist = THREE.MathUtils.clamp(size * 0.6, 4, 40);
  camera.position.set(center.x + dist*0.2, center.y + dist*0.15, center.z + dist);
  camera.lookAt(center);
  log('GLB loaded from Google Drive ✅');
}, (xhr)=>{
  if (xhr.total) {
    log(`Loading: ${((xhr.loaded/xhr.total)*100).toFixed(1)}%`);
  } else {
    log(`Loaded: ${xhr.loaded} bytes`);
  }
}, (err)=>{
  console.error(err);
  log('❌ Failed to load from Google Drive (CORS or redirect). See console.\n\n권장 대안: GitHub Releases + jsDelivr 사용.');
});

// ----- Audio (optional) -----
const audio = new Audio('./hello-mama-2025.mp3'); // 있으면 MP3 권장
audio.preload='auto';
document.getElementById('start').onclick = ()=> audio.play().catch(()=>{});

// ----- Adaptive resolution -----
let last=performance.now(), frames=0, acc=0;
function animate(now){
  const dt = (now-last)/1000; last=now;
  frames++; acc += dt;
  if (acc>=1){
    const fps = Math.round(frames/acc);
    document.getElementById('fps').textContent = 'FPS: ' + fps;
    if (fps < 28 && DPR > 0.75){ DPR = Math.max(0.5, DPR-0.25); renderer.setPixelRatio(DPR); }
    else if (fps > 55 && DPR < 1.5){ DPR = Math.min(1.5, DPR+0.25); renderer.setPixelRatio(DPR); }
    frames=0; acc=0;
  }
  controls.update();
  renderer.render(scene, camera);
  requestAnimationFrame(animate);
}
requestAnimationFrame(animate);
</script>
</body>
</html>
